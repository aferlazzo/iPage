<?php
/*

Perfect Response - Email Marketing at Its Best!
Copyright © Tony Ferlazzo 2004 
Version 1.0 Written by: Tony Ferlazzo, tony@lightning-mortgage.com

*/

?>
<HTML>
<HEAD>
<TITLE>Display All Schedule - Perfect Response</TITLE>
<meta name="robots" content="NoIndex, NoFollow">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<link rel="stylesheet" type="text/css" href="../css/PerfectResponse.css">
<style type="text/css" media="screen">
th, td {background:#fff;font-family:Verdana, Arial, Helvetica;color:#000080;font-size:x-small;padding:2px;white-space:nowrap;}
</style>
<script type="text/javascript">
<!--

function ProgressBar(Count, Total, TotalLength)
{
	Count=Count+1;
	var VisibleLength = (Count /Total) * TotalLength;
	var Bar = document.getElementById('ProgressBar');
	var BarWritten = document.getElementById('ProgressBarWritten');
	Bar.style.width=VisibleLength+"px";
	Percent = (Count /Total) * 100;
	var xxx = Math.round(Percent);
	Bar.innerHTML = "<p>"+xxx+"% Complete -- "+Count+" of "+Total+" Matches</p>";
}

//-->
</script>
</HEAD>
<BODY>
</body>
</html>
<div id='ProgressBarOutline'><div id='ProgressBar'></div></div>


<?
include ("check1.php");
$user = $_COOKIE["UName"];
include ("conn.php");
	set_time_limit(0);
$arSQL = "select arid, ardescription from autoresponders where user='$user' order by ardescription";
$result_ar = mysql_query($arSQL) or die("DisplayAllSchedule (".__LINE__.") $arSQL");
$num_rows_ar = mysql_num_rows($result_ar);

if ($num_rows_ar == 0)
{
	print ("<h1>");
	print "<i>Perfect Response</i> Mail Campaign Schedule is empty</h1>\n";
}
else
for ($count = 0; $count < $num_rows_ar; $count++)
{
	mysql_data_seek($result_ar, $count);
	$arrow = mysql_fetch_array($result_ar);
	$ardescription = $arrow[ardescription];
	$arid = $arrow[arid];
	$WithinScript = "I know the arid";
	include("settings.php");
	include("removesettings.php");
	//print("<p>arid: $arid</p>");

	// - - - - - - - - - - - - - - - - - - - - - - - - - - -
	//
	//	ReadSchedule
	//	
	// - - - - - - - - - - - - - - - - - - - - - - - - - - -

	//print ("Processing Schedule for \$arid $arid<br>");


	if($Mail_Format == 1)
	{
		$Mail_Header="Content-type: text/html; charset=iso-8859-1";
		$Mail_Footer=$Remove_HTML;
	}
	else
	{
		$Mail_Header="Content-Type: text/plain; charset=us-ascii";
		$Mail_Footer=$Remove_Text;
	}
	
	$Mail_Error_Flag = 1;
	
	$WallclockTime = mktime(date("H")+2,date("i"),date("s"),date("m"),date("d"),date("Y"));
	
	$maxSQL = "select max(seqno) as maxseq from messages where arid=$arid";
	$result_max = mysql_query($maxSQL) or die("$maxSQL");
	mysql_data_seek($result_max, 0);
	$maxrow = mysql_fetch_object($result_max);
	$maxmsg=$maxrow->maxseq;
	
	if($maxmsg<1)
		$maxmsg=0;
	
	//
	//	Get all the records that have a current message number less than the maximum messages 
	//	from the users database
	//
	
	$SQL_Statement = "SELECT * FROM users where currentmsg<=$maxmsg and arid=$arid and confirmed='Y' order by currentmsg, fname";
	$Query_Result = mysql_query($SQL_Statement);
	$NumberOfUserMatches = mysql_num_rows($Query_Result);
	$TotalSubscribers = $NumberOfUserMatches;
	if ($NumberOfUserMatches > 0)
	{
		print ("<table style='margin:16px 0;border:0 solid #000080;background:#004a8d;'>");
		//print ("<tr><td colspan='4' 	style=\"height:72px;background-image: url('images/PerfectResponseLogo-extend.jpg'); background-repeat: no-repeat;\"><br><br>&nbsp;</td></tr>");
		print ("<tr><th colspan='4' style='font-family: Verdana, Arial, Helvetica;color:#fff;background:#004a8d;font-size:medium;'>");
		print ("<h2>Schedule For '".$ardescription."'</h2></th></tr>");
		print ("<tr><th colspan='4' style='color: #fff; background:#004a8d;'>".number_format($NumberOfUserMatches)." Subscribers As of ".date('l F j, Y g:i A')."</th></tr>");		
		print ("<tr><th style='text-align:left;width:430px;'>");
		print ("Send To Name &lt;Email Address&gt;</th>");
		//print ("<th width='360px' >Next Message's Subject</th>");
		//print ("<th style='width:70px;font-size:8px;'>Send Time</th>");
		print ("<th style='width:70px;'>Send In</th>");
		print ("<th style='width:60px;'>Message<br>Number</th></tr>\n");
	}
	else
	{
		print ("<p>No messages are scheduled to be sent for $arid - $ardescription</p>");
	}
	
	//
	// for each user record...
	//	
	for($ucount=0;$ucount<$NumberOfUserMatches; $ucount++)
	{
		print("<script type='text/javascript'>ProgressBar($ucount, $TotalSubscribers, 500);</script>\n");
		mysql_data_seek($Query_Result, $ucount);
		$rowusr 		= mysql_fetch_object($Query_Result);
		$IP_Address 	= $rowusr->ip;
		$email 			= $rowusr->email;
		$MsgNo 			= $rowusr->currentmsg;
		$TimeToSendMsg	= $rowusr->senddate;

		$UserName 		= trim($rowusr->fname." ".$rowusr->lname);
		
		//print("<p>Line (".__LINE__.") Inspecting record: |$UserName| message number: $MsgNo  maxmsg: $maxmsg</p>\n");
		

		//	Print this message's fields
		//	Format this user record's Date & Time from the field Mail_Send_Date 

		//print("<p>line (".__LINE__.") row $ucount is on msg |$MsgNo| for max of |$maxmsg|</p>");
		print ("<tr><td>\n");		
		//printf ("%5s: ",number_format($ucount + 1));
		print("$UserName &lt;");
		print("$email");
		print("&gt;</td>\n");
		$sDateH = date("m-d-y H:i", $TimeToSendMsg);
		//print ("<td style='text-align:center;'>$sDateH");
		//	Format the current Date & Time		

		$cDateH = date("H");
		$cDateI = date('i');
		$cDateS = date('s');  
		$cDateM = date('m');
		$cDateD = date('d');
		$cDateY = date('y');
				
		$CurrentTime = mktime($cDateH, $cDateI, $cDateS, $cDateM, $cDateD, $cDateY);
		$Offset = $TimeToSendMsg - $CurrentTime;
		
		print ("<td style='text-align:center;'>");
			
		if ($Offset > 85399) //a day in seconds
		{
			$days = floor($Offset/85399);
			print ("$days d ");
			$Offset = $Offset % 85399;
		}
			
		if ($Offset > 3600) //an hour in seconds
		{
			$hours = floor($Offset/3600);
			print ("$hours h ");
			$Offset = $Offset % 3600;
		}
			
		if ($Offset > 60) //a minute in seconds
		{
			$minutes = floor($Offset/60);
			print ("$minutes m");
		}
			
		if ($Offset < 1)
			print("<b>Past Due</b>");
		print ("<br></td>");
		print ("<td style='text-align:center;'>".$MsgNo."</td></tr>\n");
	} //for number of users
	
	print("</table><br />\n");	
}  //end for each arid
?>
